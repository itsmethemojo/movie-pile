<!DOCTYPE HTML>

<html>

  <head>
  	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
  	<title>edit Movie Pile <%= data['id'] %></title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="/auto.css?d=24052021" type="text/css" rel="stylesheet">
    <link href="/custom.css" type="text/css" rel="stylesheet">
  </head>
  <body>
    <section>
      <p>
        Put several movie site urls in the textfield (newline separated) and then submit.
        This works with every major site e.g. <a href="https://www.imdb.com/">imdb</a>,<a href="https://www.themoviedb.org/">themoviedb</a>, <a href="https://www.rottentomatoes.com/m/alita_battle_angel">rottentomatoes</a> and so on
      </p>
    </section>
    <section>
      <p>
        <a type="button" href="/"> Back to piles</a>
      </p>
    </section>
    <section>
      <p>
        Name
        <input type="text" value="" id="movie-pile-name"/>
        <input type="hidden" value="<%= data['secret'] %>" id="movie-pile-secret"/>
      </p>
      <p>
        Share Url: 
        <code id="movie-pile-share-url">
          <%= url("/v2/#{data['id']}") %>
        </code>
      </p>
      <p>
        <button type="button" id="clipboard-button">
          Copy to clipboard
          <span id="clipboard-button-feedback"></span>
        </button>
      </p>
    </section>
    <section class="movie-pile" id="movie-pile-section">
      <p><input type="text" value=""/></p>
    </section>
    <section class="movie-pile-add" id="movie-pile-add-section">
        <p>
          <input type="button" value="Add" onclick="addMovie()"/>
        </p>
    </section>
        <input type="button" value="Save" onclick="saveMovie()"/>
        <span id="saving-feedback"></span>
    </section>
    <script>

      function addPileToCookies(){
        movie_piles = [];
        document.cookie.split(';').forEach(cookie => {
           if(cookie.trim().startsWith("movie_piles=")){
             movie_piles=JSON.parse(cookie.split("=")[1]);
           }
        });
        movie_piles.push(window.location.href);
        cookie_data = JSON.stringify(movie_piles.filter((v, i, a) => a.indexOf(v) === i));
        document.cookie = "movie_piles = " + cookie_data + ";expires=Do, 31 Dec 2037 23:59:59 GMT; path=/; secure";
      }

      function initClipboardButton() {
        var clipboard_button = document.getElementById("clipboard-button")
        var clipboard_button_feedback = document.getElementById("clipboard-button-feedback")
        clipboard_button.addEventListener('click', () => {
          var clipboard = navigator.clipboard || window.clipboard
          var share_url = document.getElementById("movie-pile-share-url").textContent

          clipboard.writeText(share_url)
            .then(() => { clipboard_button_feedback.textContent = '✔' })
            .catch(() => { clipboard_button_feedback.textContent = '❌' })
            .then(() => setTimeout(() => { clipboard_button_feedback.textContent = '' }, 1500))
        })
      }

      function init(){
        initClipboardButton();
        var request = new XMLHttpRequest();
        request.open( "GET", "<%= data['api_url'] %>", false );
        request.send( null );
        var movie_pile = JSON.parse(request.responseText);
        var moviesInputHtml = "";
        movies = movie_pile['movie_list'];
        for (var i = 0; i < movies.length; i++) {
          moviesInputHtml += '<p><input type="text" value="' + movies[i].url + '"/></p>';
        }
        document.getElementById("movie-pile-section").innerHTML = moviesInputHtml;
        document.getElementById("movie-pile-name").value = movie_pile['name'];
        addPileToCookies();
      }

      init();
      function addMovie(){
        var nextUrlInput = document.createElement("input");
        nextUrlInput.type = "text";
        nextUrlInput.value = "";
        var wrapper = document.createElement("p");
        wrapper.appendChild(nextUrlInput);
        document.getElementById("movie-pile-section").appendChild(wrapper);
      }

      function saveMovie(){
        name = document.getElementById("movie-pile-name").value;
        secret = document.getElementById("movie-pile-secret").value;
        movie_list = [];
        document.querySelectorAll("section#movie-pile-section p input").forEach(input => {
          movie_entry = input.value.trim();
          if(movie_entry !== "") {
            movie_list.push(movie_entry);
          }
        });
        var request = new XMLHttpRequest();
        request.open( "POST", "<%= data['api_url'] %>", false );
        request.setRequestHeader('TOKEN', secret);
        request.send(
          JSON.stringify(
            {
              name: name,
              movie_list: movie_list
            }
          )
        );
        var feedback = document.getElementById("saving-feedback");
        feedback.textContent = "✔ Saved successfully";
        setTimeout(() => { feedback.textContent = '' }, 1500);
      }
    </script>
  </body>
</html>
